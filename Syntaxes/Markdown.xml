<?xml version="1.0" encoding="UTF-8"?>
<syntax name="text.markdown">
	<zones>
		<zone name="literal.escape.markdown">
			<expression>\\(\\|`|\*|_|\{|}|\[|]|\(|\)|#|\+|-|\.|!)</expression>
		</zone>
		
		<include collection="markdown.headers"/>
		<include collection="markdown.stylistic"/>
		<include collection="text.lists"/>
		<include collection="markdown.relationships"/>
		
		<!-- !BLOCKQUOTE -->
		<zone name="text.blockquote">
			<starts-with>
				<expression>^([>]{1})</expression>
			</starts-with>
			<ends-with>
				<expression>^$</expression>
			</ends-with>
			<subzones>
				<include collection="text.styles"/>
				<include collection="functions.links"/>
			</subzones>
		</zone>
		
		<!-- CODE BLOCK <pre> -->
		<zone name="text.pre">
			<starts-with>
				<expression>^(\t{1}|\s{4})[^\[]</expression>
			</starts-with>
			<ends-with>
				<expression>^$</expression>
			</ends-with>
		</zone>
		
		<!-- CODE <code> -->
		<zone>
			<expression>(`[^`]*`)</expression>
			<capture number="1" name="text.code.markdown"/>
		</zone>
		
		<!-- HORIZONTAL RULER -->
		<zone name="ruler.markdown">
			<starts-with>
				<expression>^[-\*_]{3,}</expression>
			</starts-with>
			<ends-with>
				<expression>\n</expression>
			</ends-with>
		</zone>
		
	</zones>
	<library>
		<collection name="markdown.headers">
			<!-- ATX HEADERs -->
			<zone name="structural.header.atx.title">
				<expression>^(#) .+?( (#+))?$</expression>
				<capture number="1" name="delimiter.balanced.opening.hash"/>
				<capture number="3" name="delimiter.balanced.closing.hash"/>
			</zone>
			
			<zone name="structural.header.atx.section">
				<expression>^(#{2}) .+?( (#+))?$</expression>
				<capture number="1" name="delimiter.balanced.opening.hash"/>
				<capture number="3" name="delimiter.balanced.closing.hash"/>
			</zone>
			
			<zone name="structural.header.atx.tertiary">
				<expression>^(#{3,6}) .+?( (#+))?$</expression>
				<capture number="1" name="delimiter.balanced.opening.hash"/>
				<capture number="3" name="delimiter.balanced.closing.hash"/>
			</zone>
			
			<!-- SETEXT HEADERS need some serious love; how to capture without conflicting with HR elements? -->
		</collection>
		
		<collection name="markdown.stylistic">
			<!-- !BOLD -->
			<zone name="stylistic.typography.weight">
				<expression>([\*_]{2}).+?(\1)</expression>
				<capture number="1" name="delimiter.balanced.opening"/>
				<capture number="2" name="delimiter.balanced.closing"/>
			</zone>
			
			<!-- !ITALIC -->
			<zone name="stylistic.typography.variant.slant">
				<expression>([\*_]).+?(\1)</expression>
				<capture number="1" name="delimiter.balanced.opening"/>
				<capture number="2" name="delimiter.balanced.closing"/>
			</zone>
		</collection>
		
		<collection name="text.lists">
			<!-- UNORDERED LIST -->
			<zone>
				<expression>^(\t|\s)*([-+\*]{1}[^-+\*])(.*)$\n?</expression>
				<capture number="2" name="keyword.less_important.markdown"/>
				<capture number="3" name="text.list.markdown"/>
			</zone>
			
			<!-- ORDERED LIST -->
			<zone>
				<expression>^([0-9]\.[ ]{0,1})(.*)$\n?</expression>
				<capture number="1" name="keyword.less_important.markdown"/>
				<capture number="2" name="text.list.markdown"/>
			</zone>
		</collection>
		
		<collection name="markdown.relationships">
			
			<!-- AUTO LINK / E-MAIL -->
			<zone name="relationship.link.external">
				<expression>(&lt;)(https?://.*?)(>)</expression>
				<capture number="1" name="delimiter.balanced.opening.bracket"/>
				<capture number="2" name="literal.string.url"/>
				<capture number="3" name="delimiter.balanced.closing.bracket"/>
			</zone>
			<zone name="relationship.link.internal">
				<expression>(&lt;)(/|[a-zA-Z0-9_-].*?)(>)</expression>
				<capture number="1" name="delimiter.balanced.opening.bracket"/>
				<capture number="2" name="literal.string.url"/>
				<capture number="3" name="delimiter.balanced.closing.bracket"/>
			</zone>
			<zone name="relationship.link.contact">
				<expression>(&lt;)([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6})(>)</expression>
				<capture number="1" name="delimiter.balanced.opening.bracket"/>
				<capture number="2" name="literal.string.email"/>
				<capture number="3" name="delimiter.balanced.closing.bracket"/>
			</zone>
			<zone name="relationship.link.unknown">
				<expression>(&lt;)(.*?)(>)</expression>
				<capture number="1" name="delimiter.balanced.opening.bracket"/>
				<capture number="2" name="literal.string.url"/>
				<capture number="3" name="delimiter.balanced.closing.bracket"/>
			</zone>
			
			<!-- NORMAL LINK -->
			<zone name="relationship.link.inline">
				<expression>(\[).+?(\]) ?(\()([^\s]+?)(\s+(['"])(.+?)(\6))?(\))</expression>
				<capture number="1" name="delimiter.balanced.opening.square-brace"/>
				<capture number="2" name="delimiter.balanced.closing.square-brace"/>
				<capture number="3" name="delimiter.balanced.opening.parenthesis"/>
				<capture number="4" name="literal.string.url"/>
				<capture number="6" name="delimiter.balanced.opening.quote"/>
				<capture number="7" name="literal.string.title"/>
				<capture number="8" name="delimiter.balanced.closing.quote"/>
				<capture number="9" name="delimiter.balanced.closing.parenthesis"/>
			</zone>
			
			<!-- REFERENCE LINKS -->
			<zone name="relationship.link.reference">
				<expression>(\[).+?(\]) ?(\[)(.+?)(\])</expression>
				<capture number="1" name="delimiter.balanced.opening.square-brace"/>
				<capture number="2" name="delimiter.balanced.closing.square-brace"/>
				<capture number="3" name="delimiter.balanced.opening.square-brace"/>
				<capture number="4" name="keyword.internal.reference"/>
				<capture number="5" name="delimiter.balanced.closing.square-brace"/>
			</zone>
			
			<zone name="relationship.link.reference">
				<expression>(\[)(.+?)(\]) ?(\[)(\])</expression>
				<capture number="1" name="delimiter.balanced.opening.square-brace"/>
				<capture number="2" name="keyword.internal.reference"/>
				<capture number="3" name="delimiter.balanced.closing.square-brace"/>
				<capture number="4" name="delimiter.balanced.opening.square-brace"/>
				<capture number="5" name="delimiter.balanced.closing.square-brace"/>
			</zone>
					
			<!-- NORMAL IMAGE -->
			<zone name="relationship.image.inline">
				<expression>(!)(\[)(.+?)(\])(\()(.+?)(\s+(['"])(.+?)(\8))?(\))</expression>
				<capture number="1" name="metadata.operator"/>
				<capture number="2" name="delimiter.balanced.opening.square-brace"/>
				
				<capture number="4" name="delimiter.balanced.closing.square-brace"/>
				<capture number="5" name="delimiter.balanced.opening.parenthesis"/>
				<capture number="6" name="literal.string.url"/>
				<capture number="8" name="delimiter.balanced.opening.quote"/>
				<capture number="9" name="literal.string.title"/>
				<capture number="10" name="delimiter.balanced.closing.quote"/>
				<capture number="11" name="delimiter.balanced.closing.parenthesis"/>
			</zone>
			
			<!-- REFERENCE IMAGE -->
			<zone name="relationship.image.reference">
				<expression>(!)(\[)(.+?)(\])(\[)(.+?)(\])</expression>
				<capture number="1" name="metadata.operator"/>
				<capture number="2" name="delimiter.balanced.opening.square-brace"/>
				<capture number="3" name="literal.string.url"/>
				<capture number="4" name="delimiter.balanced.closing.square-brace"/>
				<capture number="5" name="delimiter.balanced.opening.square-brace"/>
				<capture number="6" name="keyword.internal.reference"/>
				<capture number="7" name="delimiter.balanced.closing.square-brace"/>
			</zone>
			
			<!-- REFERENCE DEFINITION -->
			<zone name="metadata.internal.reference">
				<expression>^ {0,3}(\[)(.+?)(\])(:)\s+(.+?)(\s+(['"])(.+?)(\7))?</expression>
				<capture number="1" name="delimiter.balanced.opening.square-brace"/>
				<capture number="2" name="keyword.internal.reference"/>
				<capture number="3" name="delimiter.balanced.closing.square-brace"/>
				<capture number="4" name="delimiter.separator"/>
				<capture number="5" name="literal.string.url"/>
				<capture number="7" name="delimiter.balanced.opening.quote"/>
				<capture number="8" name="literal.string.title"/>
				<capture number="9" name="delimiter.balanced.closing.quote"/>
			</zone>
			
		</collection>
	</library>
</syntax>