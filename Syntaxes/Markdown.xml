<?xml version="1.0" encoding="UTF-8"?>
<syntax name="text.markdown">
	<zones>
		<include collection="markdown.code"/>
		
		<zone name="literal.escape.markdown">
			<expression>\\(\\|`|\*|_|\{|}|\[|]|\(|\)|#|\+|-|\.|!)</expression>
		</zone>
		
		<include collection="markdown.headers"/>
		
		<!-- HORIZONTAL RULE -->
		<zone name="structural.separator">
			<starts-with>
				<expression>^\s*([\*_-])\s*\1\s*\1</expression>
			</starts-with>
			<ends-with>
				<expression>$\n</expression>
			</ends-with>
		</zone>
		
		<!-- !BLOCKQUOTE -->
		<zone name="structural.container.blockquote">
			<starts-with>
				<expression>(?=^\s*>)</expression>
			</starts-with>
			<ends-with>
				<expression>(?=^$)</expression>
			</ends-with>
			<subzones>
				<zone>
					<expression>^\s*(>)</expression>
					<capture number="1" name="metadata.structural"/>
				</zone>
				<include syntax="self"/>
			</subzones>
		</zone>
		
		<include collection="markdown.stylistic"/>
		<include collection="markdown.lists"/>
		<include collection="markdown.links"/>
	</zones>
	
	<library>
		<collection name="markdown.code">
			<!-- CODE BLOCK <pre> -->
			<zone name="text.pre">
				<starts-with>
					<expression>^(\t{1}|\s{4})[^\[]</expression>
				</starts-with>
				<ends-with>
					<expression>^$</expression>
				</ends-with>
			</zone>
			
			<!-- CODE <code> -->
			<zone>
				<expression>(`[^`]*`)</expression>
				<capture number="1" name="text.code.markdown"/>
			</zone>
		</collection>
		
		<collection name="markdown.headers">
			<!-- ATX HEADERs -->
			<zone name="structural.header.atx.title">
				<expression>^(#) .+?( (#+))?$</expression>
				<capture number="1" name="delimiter.balanced.begin.hash"/>
				<capture number="3" name="delimiter.balanced.end.hash"/>
			</zone>
			
			<zone name="structural.header.atx.section">
				<expression>^(#{2}) .+?( (#+))?$</expression>
				<capture number="1" name="delimiter.balanced.begin.hash"/>
				<capture number="3" name="delimiter.balanced.end.hash"/>
			</zone>
			
			<zone name="structural.header.atx.tertiary">
				<expression>^(#{3,6}) .+?( (#+))?$</expression>
				<capture number="1" name="delimiter.balanced.begin.hash"/>
				<capture number="3" name="delimiter.balanced.end.hash"/>
			</zone>
			
			<!-- SETEXT HEADERS are a big problem; for now just defining the underline as the header metadata because I can't think of a way to capture the whole thing -->
			<zone name="structural.header.setext.title">
				<starts-with>
					<expression>^(={4,})</expression>
					<capture number="1" name="medatadata.structural.header"/>
				</starts-with>
				<ends-with>
					<expression>$\n</expression>
				</ends-with>
			</zone>
			<!-- This zone competes with one type of HR, but I don't see any easy workarounds -->
			<zone name="structural.header.setext.section">
				<starts-with>
					<expression>^(-{4,})</expression>
					<capture number="1" name="medatadata.structural.header"/>
				</starts-with>
				<ends-with>
					<expression>$\n</expression>
				</ends-with>
			</zone>
			
		</collection>
		
		<collection name="markdown.stylistic">
			<include collection="markdown.bold"/>
			<include collection="markdown.slant"/>
		</collection>
		
		<collection name="markdown.bold">
			<!-- !BOLD -->
			<zone name="stylistic.typography.weight">
				<starts-with>
					<expression>([\*_]{2})(?=[a-zA-Z0-9])</expression>
					<capture number="1" name="delimiter.balanced.begin"/>
				</starts-with>
				<ends-with>
					<expression>\1</expression>
					<capture number="0" name="delimiter.balanced.end"/>
				</ends-with>
				<subzones>
					<include collection="markdown.slant"/>
				</subzones>
			</zone>
		</collection>
		
		<collection name="markdown.slant">
			<!-- !ITALIC -->
			<zone name="stylistic.typography.variant.slant">
				<starts-with>
					<expression>([\*_])(?=[a-zA-Z0-9])</expression>
					<capture number="1" name="delimiter.balanced.begin"/>
				</starts-with>
				<ends-with>
					<expression>\1</expression>
					<capture number="0" name="delimiter.balanced.end"/>
				</ends-with>
				<subzones>
					<include collection="markdown.bold"/>
				</subzones>
			</zone>
		</collection>
		
		<collection name="markdown.lists">
			<!-- UNORDERED LIST -->
			<zone name="structural.list.unordered">
				<starts-with>
					<expression>(?=^\s*[-+\*]\s+.)</expression>
				</starts-with>
				<ends-with>
					<expression>(?=^$)</expression>
				</ends-with>
				<subzones>
					<zone name="structural.list.element">
						<starts-with>
							<expression>^\s*([-+\*])\s+</expression>
							<capture number="1" name="metadata.structural"/>
						</starts-with>
						<ends-with>
							<expression>(?=^\s*[-+\*]\s)|(?=^$)</expression>
						</ends-with>
						<subzones>
							<include syntax="self"/>
						</subzones>
					</zone>
				</subzones>
			</zone>
			
			<!-- ORDERED LIST -->
			<zone name="structural.list.ordered">
				<starts-with>
					<expression>(?=^\s*[0-9]+\.\s+.)</expression>
				</starts-with>
				<ends-with>
					<expression>(?=^$)</expression>
				</ends-with>
				<subzones>
					<zone name="structural.list.element">
						<starts-with>
							<expression>^\s*([0-9]+\.)\s+</expression>
							<capture number="1" name="metadata.structural"/>
						</starts-with>
						<ends-with>
							<expression>(?=^\s*[0-9]+\.\s)|(?=^$)</expression>
						</ends-with>
						<subzones>
							<include syntax="self"/>
						</subzones>
					</zone>
				</subzones>
			</zone>
		</collection>
		
		<collection name="markdown.links">
			
			<!-- AUTO LINK / E-MAIL -->
			<zone name="structural.connector.link.external">
				<expression>(&lt;)(https?://.*?)(>)</expression>
				<capture number="1" name="delimiter.balanced.begin.bracket"/>
				<capture number="2" name="literal.string.url"/>
				<capture number="3" name="delimiter.balanced.end.bracket"/>
			</zone>
			<zone name="structural.connector.link.internal">
				<expression>(&lt;)(/|[a-zA-Z0-9_-].*?)(>)</expression>
				<capture number="1" name="delimiter.balanced.begin.bracket"/>
				<capture number="2" name="literal.string.url"/>
				<capture number="3" name="delimiter.balanced.end.bracket"/>
			</zone>
			<zone name="structural.connector.link.contact">
				<expression>(&lt;)([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6})(>)</expression>
				<capture number="1" name="delimiter.balanced.begin.bracket"/>
				<capture number="2" name="literal.string.email"/>
				<capture number="3" name="delimiter.balanced.end.bracket"/>
			</zone>
			<zone name="structural.connector.link.unknown">
				<expression>(&lt;)(.*?)(>)</expression>
				<capture number="1" name="delimiter.balanced.begin.bracket"/>
				<capture number="2" name="literal.string.url"/>
				<capture number="3" name="delimiter.balanced.end.bracket"/>
			</zone>
			
			<!-- NORMAL LINK -->
			<zone name="structural.connector.link.inline">
				<expression>(\[).+?(\]) ?(\()([^\s]+?)(\s+(['"])(.+?)(\6))?(\))</expression>
				<capture number="1" name="delimiter.balanced.begin.square-brace"/>
				<capture number="2" name="delimiter.balanced.end.square-brace"/>
				<capture number="3" name="delimiter.balanced.begin.parenthesis"/>
				<capture number="4" name="literal.string.url"/>
				<capture number="6" name="delimiter.balanced.begin.quote"/>
				<capture number="7" name="literal.string.title"/>
				<capture number="8" name="delimiter.balanced.end.quote"/>
				<capture number="9" name="delimiter.balanced.end.parenthesis"/>
			</zone>
			
			<!-- REFERENCE LINKS -->
			<zone name="structural.connector.link.reference">
				<expression>(\[).+?(\]) ?(\[)(.+?)(\])</expression>
				<capture number="1" name="delimiter.balanced.begin.square-brace"/>
				<capture number="2" name="delimiter.balanced.end.square-brace"/>
				<capture number="3" name="delimiter.balanced.begin.square-brace"/>
				<capture number="4" name="keyword.internal.reference"/>
				<capture number="5" name="delimiter.balanced.end.square-brace"/>
			</zone>
			
			<zone name="structural.connector.link.reference">
				<expression>(\[)(.+?)(\]) ?(\[)(\])</expression>
				<capture number="1" name="delimiter.balanced.begin.square-brace"/>
				<capture number="2" name="keyword.internal.reference"/>
				<capture number="3" name="delimiter.balanced.end.square-brace"/>
				<capture number="4" name="delimiter.balanced.begin.square-brace"/>
				<capture number="5" name="delimiter.balanced.end.square-brace"/>
			</zone>
					
			<!-- NORMAL IMAGE -->
			<zone name="structural.connector.image.inline">
				<expression>(!)(\[)(.+?)(\])(\()(.+?)(\s+(['"])(.+?)(\8))?(\))</expression>
				<capture number="1" name="metadata.operator"/>
				<capture number="2" name="delimiter.balanced.begin.square-brace"/>
				
				<capture number="4" name="delimiter.balanced.end.square-brace"/>
				<capture number="5" name="delimiter.balanced.begin.parenthesis"/>
				<capture number="6" name="literal.string.url"/>
				<capture number="8" name="delimiter.balanced.begin.quote"/>
				<capture number="9" name="literal.string.title"/>
				<capture number="10" name="delimiter.balanced.end.quote"/>
				<capture number="11" name="delimiter.balanced.end.parenthesis"/>
			</zone>
			
			<!-- REFERENCE IMAGE -->
			<zone name="structural.connector.image.reference">
				<expression>(!)(\[)(.+?)(\])(\[)(.+?)(\])</expression>
				<capture number="1" name="metadata.structural"/>
				<capture number="2" name="delimiter.balanced.begin.square-brace"/>
				<capture number="4" name="delimiter.balanced.end.square-brace"/>
				<capture number="5" name="delimiter.balanced.begin.square-brace"/>
				<capture number="6" name="keyword.internal.reference"/>
				<capture number="7" name="delimiter.balanced.end.square-brace"/>
			</zone>
			
			<!-- REFERENCE DEFINITION -->
			<zone name="metadata.internal.reference">
				<starts-with>
					<expression>^ {0,3}(\[)(.+)(\])(:)\s+(&lt;?)([^\s>]+)(>?)</expression>
					<capture number="1" name="delimiter.balanced.begin.square-brace"/>
					<capture number="2" name="keyword.internal.reference"/>
					<capture number="3" name="delimiter.balanced.end.square-brace"/>
					<capture number="4" name="delimiter.declarative"/>
					<capture number="5" name="delimiter.balanced.begin.bracket"/>
					<capture number="6" name="literal.string.url"/>
					<capture number="7" name="delimiter.balanced.end.bracket"/>
				</starts-with>
				<ends-with>
					<!--This might need revising; currently, with no title the item will span the line because I have to get to the next line to check it for the patterns that will clear the item-->
					<expression>((\s+(['"\(])(.+?)(\9|\)))$)|((?=^\s*$)|(?=^\s*\[.+\]:))</expression>
					<capture number="3" name="delimiter.balanced.begin"/>
					<capture number="4" name="literal.string.title"/>
					<capture number="5" name="delimiter.balanced.end"/>
				</ends-with>
			</zone>
		</collection>
	</library>
</syntax>